THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.isSpriteCanvasMaterial=!0,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){function t(){ve.setRGB(0,0,0),xe.setRGB(0,0,0),ye.setRGB(0,0,0);for(var e=0,t=R.length;e<t;e++){var i=R[e],r=i.color;i.isAmbientLight?ve.add(r):i.isDirectionalLight?xe.add(r):i.isPointLight&&ye.add(r)}}function i(e,t,i){for(var r=0,o=R.length;r<o;r++){var n=R[r];if(de.copy(n.color),n.isDirectionalLight){a=ue.setFromMatrixPosition(n.matrixWorld).normalize();if((s=t.dot(a))<=0)continue;s*=n.intensity,i.add(de.multiplyScalar(s))}else if(n.isPointLight){var a=ue.setFromMatrixPosition(n.matrixWorld),s=t.dot(ue.subVectors(a,e).normalize());if(s<=0)continue;if(0==(s*=0==n.distance?1:1-Math.min(e.distanceTo(a)/n.distance,1)))continue;s*=n.intensity,i.add(de.multiplyScalar(s))}}}function r(e,t,i){h(i.opacity),f(i.blending);var r=t.scale.x*U,o=t.scale.y*q,n=Math.sqrt(r*r+o*o);if(Ee.min.set(e.x-n,e.y-n),Ee.max.set(e.x+n,e.y+n),i.isSpriteMaterial){var a=i.map;if(null!==a){var s=he[a.id];if(void 0!==s&&s.version===a.version||(s=c(a),he[a.id]=s),void 0!==s.canvas){y(s.canvas);var l=a.image,p=l.width*a.offset.x,d=l.height*a.offset.y,m=l.width*a.repeat.x,E=l.height*a.repeat.y,v=r/m,u=o/E;Z.save(),Z.translate(e.x,e.y),0!==i.rotation&&Z.rotate(i.rotation),Z.translate(-r/2,-o/2),Z.scale(v,u),Z.translate(-p,-d),Z.fillRect(p,d,m,E),Z.restore()}}else y(i.color.getStyle()),Z.save(),Z.translate(e.x,e.y),0!==i.rotation&&Z.rotate(i.rotation),Z.scale(r,-o),Z.fillRect(-.5,-.5,1,1),Z.restore()}else i.isSpriteCanvasMaterial?(x(i.color.getStyle()),y(i.color.getStyle()),Z.save(),Z.translate(e.x,e.y),0!==i.rotation&&Z.rotate(i.rotation),Z.scale(r,o),i.program(Z),Z.restore()):i.isPointsMaterial&&(y(i.color.getStyle()),Z.save(),Z.translate(e.x,e.y),0!==i.rotation&&Z.rotate(i.rotation),Z.scale(r*i.size,-o*i.size),Z.fillRect(-.5,-.5,1,1),Z.restore())}function o(e,t,i,r){if(h(r.opacity),f(r.blending),Z.beginPath(),Z.moveTo(e.positionScreen.x,e.positionScreen.y),Z.lineTo(t.positionScreen.x,t.positionScreen.y),r.isLineBasicMaterial){if(m(r.linewidth),E(r.linecap),v(r.linejoin),r.vertexColors!==THREE.VertexColors)x(r.color.getStyle());else{var o=i.vertexColors[0].getStyle(),n=i.vertexColors[1].getStyle();if(o===n)x(o);else{try{var a=Z.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);a.addColorStop(0,o),a.addColorStop(1,n)}catch(e){a=o}x(a)}}Z.stroke(),Ee.expandByScalar(2*r.linewidth)}else r.isLineDashedMaterial&&(m(r.linewidth),E(r.linecap),v(r.linejoin),x(r.color.getStyle()),u([r.dashSize,r.gapSize]),Z.stroke(),Ee.expandByScalar(2*r.linewidth),u([]))}function n(e,t,r,o,n,c,d,m){N.info.render.vertices+=3,N.info.render.faces++,h(m.opacity),f(m.blending),C=e.positionScreen.x,H=e.positionScreen.y,b=t.positionScreen.x,L=t.positionScreen.y,B=r.positionScreen.x,P=r.positionScreen.y,a(C,H,b,L,B,P),(m.isMeshLambertMaterial||m.isMeshPhongMaterial||m.isMeshStandardMaterial)&&null===m.map?(ce.copy(m.color),pe.copy(m.emissive),m.vertexColors===THREE.FaceColors&&ce.multiply(d.color),le.copy(ve),ge.copy(e.positionWorld).add(t.positionWorld).add(r.positionWorld).divideScalar(3),i(ge,d.normalModel,le),le.multiply(ce).add(pe),!0===m.wireframe?s(le,m.wireframeLinewidth,m.wireframeLinecap,m.wireframeLinejoin):l(le)):m.isMeshBasicMaterial||m.isMeshLambertMaterial||m.isMeshPhongMaterial||m.isMeshStandardMaterial?null!==m.map?m.map.mapping===THREE.UVMapping&&(z=d.uvs,p(C,H,b,L,B,P,z[o].x,z[o].y,z[n].x,z[n].y,z[c].x,z[c].y,m.map)):null!==m.envMap?m.envMap.mapping===THREE.SphericalReflectionMapping&&(Se.copy(d.vertexNormalsModel[o]).applyMatrix3(Re),W=.5*Se.x+.5,j=.5*Se.y+.5,Se.copy(d.vertexNormalsModel[n]).applyMatrix3(Re),V=.5*Se.x+.5,k=.5*Se.y+.5,Se.copy(d.vertexNormalsModel[c]).applyMatrix3(Re),D=.5*Se.x+.5,F=.5*Se.y+.5,p(C,H,b,L,B,P,W,j,V,k,D,F,m.envMap)):(le.copy(m.color),m.vertexColors===THREE.FaceColors&&le.multiply(d.color),!0===m.wireframe?s(le,m.wireframeLinewidth,m.wireframeLinecap,m.wireframeLinejoin):l(le)):m.isMeshNormalMaterial?(Se.copy(d.normalModel).applyMatrix3(Re),le.setRGB(Se.x,Se.y,Se.z).multiplyScalar(.5).addScalar(.5),!0===m.wireframe?s(le,m.wireframeLinewidth,m.wireframeLinecap,m.wireframeLinejoin):l(le)):(le.setRGB(1,1,1),!0===m.wireframe?s(le,m.wireframeLinewidth,m.wireframeLinecap,m.wireframeLinejoin):l(le))}function a(e,t,i,r,o,n){Z.beginPath(),Z.moveTo(e,t),Z.lineTo(i,r),Z.lineTo(o,n),Z.closePath()}function s(e,t,i,r){m(t),E(i),v(r),x(e.getStyle()),Z.stroke(),Ee.expandByScalar(2*t)}function l(e){y(e.getStyle()),Z.fill()}function c(e){if(0===e.version||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture)return{canvas:void 0,version:e.version};var t=e.image;if(!1===t.complete)return{canvas:void 0,version:0};var i=e.wrapS===THREE.RepeatWrapping||e.wrapS===THREE.MirroredRepeatWrapping,r=e.wrapT===THREE.RepeatWrapping||e.wrapT===THREE.MirroredRepeatWrapping,o=e.wrapS===THREE.MirroredRepeatWrapping,n=e.wrapT===THREE.MirroredRepeatWrapping,a=document.createElement("canvas");a.width=t.width*(o?2:1),a.height=t.height*(n?2:1);var s=a.getContext("2d");s.setTransform(1,0,0,-1,0,t.height),s.drawImage(t,0,0),!0===o&&(s.setTransform(-1,0,0,-1,t.width,t.height),s.drawImage(t,-t.width,0)),!0===n&&(s.setTransform(1,0,0,1,0,0),s.drawImage(t,0,t.height)),!0===o&&!0===n&&(s.setTransform(-1,0,0,1,t.width,0),s.drawImage(t,-t.width,t.height));var l="no-repeat";!0===i&&!0===r?l="repeat":!0===i?l="repeat-x":!0===r&&(l="repeat-y");var c=Z.createPattern(a,l);return e.onUpdate&&e.onUpdate(e),{canvas:c,version:e.version}}function p(e,t,i,r,o,n,a,s,l,p,d,h,f){var m=he[f.id];if(void 0!==m&&m.version===f.version||(m=c(f),he[f.id]=m),void 0===m.canvas)return y("rgba( 0, 0, 0, 1)"),void Z.fill();y(m.canvas);var E,v,x,u,g,S,R,T,w=f.offset.x/f.repeat.x,M=f.offset.y/f.repeat.y,C=f.image.width*f.repeat.x,H=f.image.height*f.repeat.y;l=(l+w)*C,p=(p+M)*H,d=(d+w)*C,h=(h+M)*H,i-=e,r-=t,o-=e,n-=t,0!==(R=(l-=a=(a+w)*C)*(h-=s=(s+M)*H)-(d-=a)*(p-=s))&&(g=e-(E=(h*i-p*o)*(T=1/R))*a-(x=(l*o-d*i)*T)*s,S=t-(v=(h*r-p*n)*T)*a-(u=(l*n-d*r)*T)*s,Z.save(),Z.transform(E,v,x,u,g,S),Z.fill(),Z.restore())}function d(e,t,i){var r,o=t.x-e.x,n=t.y-e.y,a=o*o+n*n;0!==a&&(o*=r=i/Math.sqrt(a),n*=r,t.x+=o,t.y+=n,e.x-=o,e.y-=n)}function h(e){ee!==e&&(Z.globalAlpha=e,ee=e)}function f(e){te!==e&&(e===THREE.NormalBlending?Z.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?Z.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending?Z.globalCompositeOperation="darker":e===THREE.MultiplyBlending&&(Z.globalCompositeOperation="multiply"),te=e)}function m(e){oe!==e&&(Z.lineWidth=e,oe=e)}function E(e){ne!==e&&(Z.lineCap=e,ne=e)}function v(e){ae!==e&&(Z.lineJoin=e,ae=e)}function x(e){ie!==e&&(Z.strokeStyle=e,ie=e)}function y(e){re!==e&&(Z.fillStyle=e,re=e)}function u(e){se.length!==e.length&&(Z.setLineDash(e),se=e)}console.log("THREE.CanvasRenderer",THREE.REVISION),e=e||{};var g,S,R,T,w,M,C,H,b,L,B,P,z,W,j,V,k,D,F,N=this,O=new THREE.Projector,A=void 0!==e.canvas?e.canvas:document.createElement("canvas"),I=A.width,G=A.height,U=Math.floor(I/2),q=Math.floor(G/2),J=0,K=0,Q=I,X=G,Y=1,Z=A.getContext("2d",{alpha:!0===e.alpha}),$=new THREE.Color(0),_=!0===e.alpha?0:1,ee=1,te=0,ie=null,re=null,oe=null,ne=null,ae=null,se=[],le=new THREE.Color,ce=new THREE.Color,pe=new THREE.Color,de=new THREE.Color,he={},fe=new THREE.Box2,me=new THREE.Box2,Ee=new THREE.Box2,ve=new THREE.Color,xe=new THREE.Color,ye=new THREE.Color,ue=new THREE.Vector3,ge=new THREE.Vector3,Se=new THREE.Vector3,Re=new THREE.Matrix3;void 0===Z.setLineDash&&(Z.setLineDash=function(){}),this.domElement=A,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return Z},this.getContextAttributes=function(){return Z.getContextAttributes()},this.getPixelRatio=function(){return Y},this.setPixelRatio=function(e){void 0!==e&&(Y=e)},this.setSize=function(e,t,i){I=e*Y,G=t*Y,A.width=I,A.height=G,U=Math.floor(I/2),q=Math.floor(G/2),!1!==i&&(A.style.width=e+"px",A.style.height=t+"px"),fe.min.set(-U,-q),fe.max.set(U,q),me.min.set(-U,-q),me.max.set(U,q),ee=1,te=0,ie=null,re=null,oe=null,ne=null,ae=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,r){J=e*Y,K=t*Y,Q=i*Y,X=r*Y},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(e,t){$.set(e),_=void 0!==t?t:1,me.min.set(-U,-q),me.max.set(U,q)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return $},this.getClearAlpha=function(){return _},this.getMaxAnisotropy=function(){return 0},this.clear=function(){!1===me.isEmpty()&&(me.intersect(fe),me.expandByScalar(2),me.min.x=me.min.x+U,me.min.y=-me.min.y+q,me.max.x=me.max.x+U,me.max.y=-me.max.y+q,_<1&&Z.clearRect(0|me.min.x,0|me.max.y,me.max.x-me.min.x|0,me.min.y-me.max.y|0),_>0&&(f(THREE.NormalBlending),h(1),y("rgba("+Math.floor(255*$.r)+","+Math.floor(255*$.g)+","+Math.floor(255*$.b)+","+_+")"),Z.fillRect(0|me.min.x,0|me.max.y,me.max.x-me.min.x|0,me.min.y-me.max.y|0)),me.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,i){if(void 0!==i.isCamera){var a=e.background;a&&a.isColor?(y("rgb("+Math.floor(255*a.r)+","+Math.floor(255*a.g)+","+Math.floor(255*a.b)+")"),Z.fillRect(0,0,I,G)):!0===this.autoClear&&this.clear(),N.info.render.vertices=0,N.info.render.faces=0,Z.setTransform(Q/I,0,0,-X/G,J,G-K),Z.translate(U,q),g=O.projectScene(e,i,this.sortObjects,this.sortElements),S=g.elements,R=g.lights,Re.getNormalMatrix(i.matrixWorldInverse),t();for(var s=0,l=S.length;s<l;s++){var c=S[s],p=c.material;if(void 0!==p&&0!==p.opacity){if(Ee.makeEmpty(),c instanceof THREE.RenderableSprite)(T=c).x*=U,T.y*=q,r(T,c,p);else if(c instanceof THREE.RenderableLine)T=c.v1,w=c.v2,T.positionScreen.x*=U,T.positionScreen.y*=q,w.positionScreen.x*=U,w.positionScreen.y*=q,Ee.setFromPoints([T.positionScreen,w.positionScreen]),!0===fe.intersectsBox(Ee)&&o(T,w,c,p);else if(c instanceof THREE.RenderableFace){if(T=c.v1,w=c.v2,M=c.v3,T.positionScreen.z<-1||T.positionScreen.z>1)continue;if(w.positionScreen.z<-1||w.positionScreen.z>1)continue;if(M.positionScreen.z<-1||M.positionScreen.z>1)continue;T.positionScreen.x*=U,T.positionScreen.y*=q,w.positionScreen.x*=U,w.positionScreen.y*=q,M.positionScreen.x*=U,M.positionScreen.y*=q,p.overdraw>0&&(d(T.positionScreen,w.positionScreen,p.overdraw),d(w.positionScreen,M.positionScreen,p.overdraw),d(M.positionScreen,T.positionScreen,p.overdraw)),Ee.setFromPoints([T.positionScreen,w.positionScreen,M.positionScreen]),!0===fe.intersectsBox(Ee)&&n(T,w,M,0,1,2,c,p)}me.union(Ee)}}Z.setTransform(1,0,0,1,0,0)}else console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.")}};
